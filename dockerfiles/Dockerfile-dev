#=======================
FROM ghcr.io/astral-sh/uv:python3.14-bookworm-slim AS base
#=======================

RUN apt-get update \
    && apt-get install -y ca-certificates git curl

WORKDIR /app

# Copy uv files
COPY pyproject.toml .
COPY uv.lock .
COPY .python-version .

# Copy project files
COPY README.md .
COPY metadata_backend ./metadata_backend
COPY private/private_jwks.json ./private/private_jwks.json

# Install dependencies and create virtual environment
RUN uv sync --dev

# Use virtual environment by default
ENV PATH="/app/.venv/bin:$PATH"

#=======================
FROM base AS test
#=======================

# Copy test files so tests can be run in the dev container
COPY tests ./tests
COPY .pytest.ini .
